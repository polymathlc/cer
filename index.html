<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CER Question Builder — Polymath Learning Centre</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ========== CSS VARIABLES & RESET ========== */
:root {
  --bg: #f4f1ec;
  --surface: #ffffff;
  --surface-alt: #faf8f5;
  --border: #e2ddd5;
  --border-focus: #4a7c59;
  --text: #2c2a27;
  --text-muted: #7a756d;
  --text-light: #a09a91;
  --primary: #4a7c59;
  --primary-hover: #3d6a4b;
  --primary-light: #e8f0ea;
  --accent-red: #d94f4f;
  --accent-red-light: #fef0f0;
  --accent-blue: #4a6fa5;
  --accent-blue-light: #edf2f9;
  --accent-orange: #d4882a;
  --accent-orange-light: #fef6e8;
  --accent-purple: #7b5ea7;
  --accent-purple-light: #f3eff8;
  --accent-teal: #3d8b8b;
  --accent-teal-light: #ebf5f5;
  --yellow-highlight: #fff3a8;
  --yellow-border: #e6d44d;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 20px;
  --transition: 0.2s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 15px; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ========== LAYOUT ========== */
.app-wrapper { display: flex; min-height: 100vh; }

/* ========== SIDEBAR ========== */
.sidebar {
  width: 260px;
  background: var(--text);
  color: #fff;
  padding: 0;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 100;
  transition: transform var(--transition);
}
.sidebar-brand {
  padding: 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.sidebar-brand h1 {
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}
.sidebar-brand span {
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  color: rgba(255,255,255,0.4);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  display: block;
  margin-top: 4px;
}
.sidebar-nav {
  flex: 1;
  padding: 16px 12px;
  overflow-y: auto;
}
.nav-section-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(255,255,255,0.3);
  padding: 16px 12px 8px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 0.88rem;
  font-weight: 500;
  color: rgba(255,255,255,0.6);
  transition: all var(--transition);
  margin-bottom: 2px;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.9); }
.nav-item.active { background: var(--primary); color: #fff; }
.nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
.nav-item .badge {
  margin-left: auto;
  background: rgba(255,255,255,0.15);
  padding: 1px 8px;
  border-radius: 10px;
  font-size: 0.72rem;
  font-family: 'Space Mono', monospace;
}
.sidebar-footer {
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.08);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.82rem;
  color: rgba(255,255,255,0.5);
}
.avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.78rem; color: #fff;
}

/* ========== MAIN CONTENT ========== */
.main-content {
  margin-left: 260px;
  flex: 1;
  min-height: 100vh;
}
.page-header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 20px 36px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 50;
}
.page-header h2 {
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}
.page-header .subtitle {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-top: 2px;
}
.page-body {
  padding: 28px 36px;
  max-width: 900px;
}

/* ========== FORM ELEMENTS ========== */
.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.form-input, .form-select {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.92rem;
  background: var(--surface);
  color: var(--text);
  transition: border-color var(--transition), box-shadow var(--transition);
  outline: none;
}
.form-input:focus, .form-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-light);
}
.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237a756d' viewBox='0 0 16 16'%3E%3Cpath d='M4.5 6l3.5 4 3.5-4z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1.5fr 1fr;
  gap: 16px;
}
optgroup {
  font-weight: 700;
  color: var(--text-muted);
  font-size: 0.85rem;
}
option {
  font-weight: 400;
  color: var(--text);
  padding: 4px 0;
}

/* ========== BLOCKS AREA ========== */
.blocks-container {
  margin-top: 24px;
}
.blocks-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* Block Card */
.block-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
  transition: box-shadow var(--transition), border-color var(--transition);
  position: relative;
}
.block-card:hover {
  box-shadow: var(--shadow-sm);
}
.block-card.dragging {
  opacity: 0.5;
  border-style: dashed;
}
.block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  background: var(--surface-alt);
}
.block-type-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 4px;
}
.block-type-badge.text-badge { background: var(--accent-blue-light); color: var(--accent-blue); }
.block-type-badge.image-badge { background: var(--accent-purple-light); color: var(--accent-purple); }
.block-type-badge.answer-badge { background: var(--primary-light); color: var(--primary); }
.block-type-badge.explanation-badge { background: var(--accent-orange-light); color: var(--accent-orange); }
.block-type-badge.video-badge { background: var(--accent-red-light); color: var(--accent-red); }
.block-type-badge.table-badge { background: var(--accent-teal-light); color: var(--accent-teal); }
.block-type-badge svg { width: 13px; height: 13px; }

.block-actions {
  display: flex;
  align-items: center;
  gap: 4px;
}
.block-action-btn {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border: none; background: transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text-muted);
  transition: all var(--transition);
}
.block-action-btn:hover { background: rgba(0,0,0,0.05); color: var(--text); }
.block-action-btn.delete:hover { background: var(--accent-red-light); color: var(--accent-red); }
.block-action-btn svg { width: 15px; height: 15px; }

.drag-handle {
  cursor: grab;
  color: var(--text-light);
  display: flex;
  padding: 4px;
}
.drag-handle:active { cursor: grabbing; }

.block-body {
  padding: 14px;
}

/* Text Block Toolbar */
.text-toolbar {
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.toolbar-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid transparent;
  background: transparent;
  border-radius: 4px;
  cursor: pointer;
  color: var(--text);
  font-size: 0.82rem;
  font-weight: 700;
  transition: all var(--transition);
}
.toolbar-btn:hover { background: var(--surface-alt); border-color: var(--border); }
.toolbar-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
.toolbar-divider {
  width: 1px;
  height: 20px;
  background: var(--border);
  margin: 0 4px;
}
.toolbar-select {
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  font-family: inherit;
  font-size: 0.78rem;
  background: var(--surface);
  cursor: pointer;
  outline: none;
}

/* Content Editable */
.content-editable {
  min-height: 80px;
  padding: 12px;
  outline: none;
  font-size: 0.92rem;
  line-height: 1.7;
  color: var(--text);
}
.content-editable:empty::before {
  content: attr(data-placeholder);
  color: var(--text-light);
  pointer-events: none;
}
.content-editable:focus {
  background: var(--surface-alt);
  border-radius: var(--radius-sm);
}

/* Image Block */
.image-url-input {
  display: flex;
  align-items: center;
  gap: 8px;
}
.image-url-input input {
  flex: 1;
}
.image-preview {
  margin-top: 10px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
  max-height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--surface-alt);
}
.image-preview img {
  max-width: 100%;
  max-height: 300px;
  object-fit: contain;
}
.image-error {
  padding: 20px;
  text-align: center;
  color: var(--accent-orange);
  font-size: 0.85rem;
}
.image-error svg { width: 20px; height: 20px; margin-bottom: 6px; }

/* Table Block */
.table-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.table-controls label {
  font-size: 0.82rem;
  color: var(--text-muted);
}
.table-controls input[type="number"] {
  width: 60px;
  padding: 5px 8px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  font-family: inherit;
  font-size: 0.85rem;
  text-align: center;
  outline: none;
}
.table-controls input[type="number"]:focus {
  border-color: var(--primary);
}
.editable-table {
  width: 100%;
  border-collapse: collapse;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.editable-table th, .editable-table td {
  border: 1px solid var(--border);
  padding: 8px 12px;
  text-align: left;
  font-size: 0.88rem;
}
.editable-table th {
  background: var(--surface-alt);
  font-weight: 600;
  font-size: 0.82rem;
  color: var(--text-muted);
}
.editable-table td[contenteditable] {
  outline: none;
  cursor: text;
}
.editable-table td[contenteditable]:focus {
  background: var(--primary-light);
}

/* Answer Block - CER Framework */
.cer-section {
  margin-bottom: 14px;
}
.cer-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 700;
  margin-bottom: 6px;
  padding: 3px 10px;
  border-radius: 4px;
  display: inline-block;
}
.cer-label.claim-label { background: var(--accent-blue-light); color: var(--accent-blue); }
.cer-label.evidence-label { background: var(--accent-orange-light); color: var(--accent-orange); }
.cer-label.reasoning-label { background: var(--primary-light); color: var(--primary); }

.cer-textarea {
  width: 100%;
  min-height: 60px;
  padding: 10px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.9rem;
  line-height: 1.6;
  resize: vertical;
  outline: none;
  transition: border-color var(--transition);
}
.cer-textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-light);
}

/* ========== ADD BLOCK BUTTONS ========== */
.add-block-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1.5px dashed var(--border);
}
.add-block-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  font-family: inherit;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  color: var(--text-muted);
}
.add-block-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
}
.add-block-btn svg { width: 14px; height: 14px; }
.add-block-btn.text-add:hover { border-color: var(--accent-blue); color: var(--accent-blue); background: var(--accent-blue-light); }
.add-block-btn.answer-add:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
.add-block-btn.explanation-add:hover { border-color: var(--accent-orange); color: var(--accent-orange); background: var(--accent-orange-light); }
.add-block-btn.video-add:hover { border-color: var(--accent-red); color: var(--accent-red); background: var(--accent-red-light); }
.add-block-btn.image-add:hover { border-color: var(--accent-purple); color: var(--accent-purple); background: var(--accent-purple-light); }
.add-block-btn.table-add:hover { border-color: var(--accent-teal); color: var(--accent-teal); background: var(--accent-teal-light); }

/* ========== ACTION BUTTONS ========== */
.action-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 28px;
  flex-wrap: wrap;
}
.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 11px 22px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}
.btn svg { width: 16px; height: 16px; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn-danger { background: var(--accent-red); color: #fff; }
.btn-danger:hover { background: #c04444; transform: translateY(-1px); }
.btn-outline {
  background: var(--surface);
  color: var(--text);
  border: 1.5px solid var(--border);
}
.btn-outline:hover { border-color: var(--text-muted); background: var(--surface-alt); }
.btn-orange { background: var(--accent-orange); color: #fff; }
.btn-orange:hover { background: #c07a24; transform: translateY(-1px); }
.btn-blue { background: var(--accent-blue); color: #fff; }
.btn-blue:hover { background: #3d5f90; transform: translateY(-1px); }

/* ========== PREVIEW MODE ========== */
.preview-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  display: none;
  align-items: flex-start;
  justify-content: center;
  overflow-y: auto;
  padding: 40px 20px;
  backdrop-filter: blur(4px);
}
.preview-overlay.active { display: flex; }

.preview-panel {
  background: var(--surface);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 780px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.preview-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 24px;
  background: var(--primary);
  color: #fff;
}
.preview-header h3 { font-size: 1.05rem; font-weight: 700; }
.preview-close {
  width: 32px; height: 32px;
  border: none;
  background: rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background var(--transition);
}
.preview-close:hover { background: rgba(255,255,255,0.3); }

.preview-toolbar {
  padding: 12px 24px;
  background: var(--surface-alt);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.preview-toolbar .hint {
  font-size: 0.82rem;
  color: var(--text-muted);
}
.blank-count {
  font-family: 'Space Mono', monospace;
  font-size: 0.78rem;
  padding: 4px 12px;
  background: var(--yellow-highlight);
  border: 1px solid var(--yellow-border);
  border-radius: 4px;
  font-weight: 700;
  color: #8a7a10;
}

.preview-body {
  padding: 28px 28px 36px;
}
.preview-question-title {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 6px;
}
.preview-meta {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  display: flex;
  gap: 12px;
}
.preview-meta .tag {
  padding: 2px 10px;
  border-radius: 4px;
  background: var(--surface-alt);
  border: 1px solid var(--border);
}

.preview-content {
  line-height: 1.85;
  font-size: 0.95rem;
}
.preview-content p { margin-bottom: 14px; }
.preview-content img {
  max-width: 100%;
  border-radius: var(--radius-sm);
  margin: 12px 0;
  border: 1px solid var(--border);
}
.preview-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 14px 0;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.preview-content table th,
.preview-content table td {
  border: 1px solid var(--border);
  padding: 10px 14px;
  text-align: left;
  font-size: 0.9rem;
}
.preview-content table th {
  background: var(--surface-alt);
  font-weight: 600;
}

/* CER Answer Preview */
.cer-preview-section {
  margin: 14px 0;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
}
.cer-preview-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 6px 14px;
  font-weight: 700;
  border-bottom: 1px solid var(--border);
}
.cer-preview-label.claim-bg { background: var(--accent-blue-light); color: var(--accent-blue); }
.cer-preview-label.evidence-bg { background: var(--accent-orange-light); color: var(--accent-orange); }
.cer-preview-label.reasoning-bg { background: var(--primary-light); color: var(--primary); }
.cer-preview-content {
  padding: 12px 14px;
  line-height: 1.8;
}

/* Selectable words in preview */
.selectable-word {
  cursor: pointer;
  padding: 1px 2px;
  border-radius: 3px;
  transition: background var(--transition);
  display: inline;
}
.selectable-word:hover {
  background: #e8e4dc;
}
.selectable-word.blanked {
  background: var(--yellow-highlight);
  border-bottom: 2px solid var(--yellow-border);
  font-weight: 600;
}

/* Explanation block in preview */
.explanation-preview {
  margin: 14px 0;
  padding: 14px 18px;
  background: var(--accent-orange-light);
  border: 1px solid #f0dfc0;
  border-radius: var(--radius-md);
  border-left: 4px solid var(--accent-orange);
}
.explanation-preview .exp-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--accent-orange);
  font-weight: 700;
  margin-bottom: 6px;
}

/* Video embed */
.video-embed {
  margin: 14px 0;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: #000;
  aspect-ratio: 16/9;
}
.video-embed iframe {
  width: 100%;
  height: 100%;
  border: none;
}
.video-url-display {
  margin: 10px 0;
  padding: 10px 14px;
  background: var(--accent-red-light);
  border: 1px solid #f0c0c0;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  color: var(--accent-red);
  word-break: break-all;
}

/* ========== QUESTION BANK ========== */
.question-bank-grid {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.qb-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  padding: 18px 20px;
  transition: all var(--transition);
  cursor: pointer;
}
.qb-card:hover {
  border-color: var(--primary);
  box-shadow: var(--shadow-sm);
}
.qb-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 8px;
}
.qb-card-title {
  font-size: 1rem;
  font-weight: 700;
}
.qb-card-meta {
  display: flex;
  gap: 8px;
  margin-top: 6px;
  flex-wrap: wrap;
}
.qb-tag {
  font-size: 0.72rem;
  padding: 2px 10px;
  border-radius: 4px;
  font-weight: 600;
  font-family: 'Space Mono', monospace;
  letter-spacing: 0.04em;
}
.qb-tag.category { background: var(--accent-blue-light); color: var(--accent-blue); }
.qb-tag.topic { background: var(--primary-light); color: var(--primary); }
.qb-tag.blanks { background: var(--yellow-highlight); color: #8a7a10; border: 1px solid var(--yellow-border); }
.qb-card-preview {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.5;
  margin-top: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.qb-card-actions {
  display: flex;
  gap: 6px;
}
.qb-action-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--border);
  background: var(--surface);
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--text-muted);
  transition: all var(--transition);
}
.qb-action-btn:hover { border-color: var(--primary); color: var(--primary); }
.qb-action-btn.delete-qb:hover { border-color: var(--accent-red); color: var(--accent-red); }
.qb-action-btn svg { width: 14px; height: 14px; }

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state svg { width: 48px; height: 48px; margin-bottom: 14px; opacity: 0.4; }
.empty-state h3 { font-size: 1.1rem; margin-bottom: 6px; color: var(--text); }
.empty-state p { font-size: 0.88rem; }

/* ========== STUDENT VIEW ========== */
.student-view-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: 24px;
}
.student-card-header {
  padding: 16px 22px;
  background: var(--surface-alt);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.student-card-header h3 {
  font-size: 1.05rem;
  font-weight: 700;
}
.student-card-body {
  padding: 22px;
  line-height: 1.85;
}
.student-card-body img {
  max-width: 100%;
  border-radius: var(--radius-sm);
  margin: 12px 0;
  border: 1px solid var(--border);
}
.student-card-body table {
  width: 100%;
  border-collapse: collapse;
  margin: 14px 0;
}
.student-card-body table th,
.student-card-body table td {
  border: 1px solid var(--border);
  padding: 10px 14px;
  font-size: 0.9rem;
}
.student-card-body table th {
  background: var(--surface-alt);
  font-weight: 600;
}

/* Blank input for student */
.blank-input {
  display: inline-block;
  min-width: 120px;
  padding: 3px 8px;
  border: none;
  border-bottom: 2px solid var(--primary);
  background: var(--primary-light);
  font-family: inherit;
  font-size: inherit;
  outline: none;
  transition: border-color var(--transition);
  text-align: center;
}
.blank-input:focus {
  border-bottom-color: var(--accent-blue);
  background: var(--accent-blue-light);
}

.cer-student-section {
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  margin: 14px 0;
  overflow: hidden;
}
.cer-student-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 8px 14px;
  font-weight: 700;
  border-bottom: 1px solid var(--border);
}
.cer-student-content {
  padding: 12px 14px;
  line-height: 1.8;
}

.submit-row {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 20px;
}

/* ========== TOAST ========== */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  padding: 12px 20px;
  border-radius: var(--radius-sm);
  font-size: 0.88rem;
  font-weight: 500;
  color: #fff;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.success { background: var(--primary); }
.toast.error { background: var(--accent-red); }
.toast.info { background: var(--accent-blue); }
@keyframes toastIn {
  from { transform: translateX(30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* ========== LOGIN PAGE ========== */
.login-page {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: var(--bg);
}
.login-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 40px 36px;
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-md);
  text-align: center;
}
.login-card .logo-icon {
  width: 56px; height: 56px;
  background: var(--primary);
  border-radius: var(--radius-md);
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 20px;
}
.login-card .logo-icon svg { width: 28px; height: 28px; color: #fff; }
.login-card h2 {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.login-card .login-sub {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 28px;
}
.login-card .form-group { text-align: left; }
.login-card .btn { width: 100%; justify-content: center; margin-top: 8px; }
.login-error {
  font-size: 0.82rem;
  color: var(--accent-red);
  margin-top: 10px;
  display: none;
}

/* ========== VETTING LIST ========== */
.vetting-badge {
  font-size: 0.72rem;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
}
.vetting-badge.pending { background: var(--accent-orange-light); color: var(--accent-orange); }
.vetting-badge.approved { background: var(--primary-light); color: var(--primary); }
.vetting-badge.rejected { background: var(--accent-red-light); color: var(--accent-red); }

/* ========== FILTER BAR ========== */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filter-bar .search-box {
  flex: 1;
  min-width: 200px;
  position: relative;
}
.filter-bar .search-box input {
  width: 100%;
  padding: 9px 14px 9px 36px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.88rem;
  outline: none;
  background: var(--surface);
}
.filter-bar .search-box input:focus { border-color: var(--primary); }
.filter-bar .search-box svg {
  position: absolute;
  left: 11px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px; height: 16px;
  color: var(--text-muted);
}
.filter-bar select {
  padding: 9px 32px 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.85rem;
  background: var(--surface);
  cursor: pointer;
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237a756d' viewBox='0 0 16 16'%3E%3Cpath d='M4.5 6l3.5 4 3.5-4z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main-content { margin-left: 0; }
  .page-body { padding: 20px 16px; }
  .page-header { padding: 16px 20px; }
  .form-row, .form-row-3 { grid-template-columns: 1fr; }
  .action-row { flex-direction: column; }
  .action-row .btn { width: 100%; justify-content: center; }
  .mobile-toggle {
    display: flex !important;
  }
}
.mobile-toggle {
  display: none;
  width: 36px; height: 36px;
  border: 1px solid var(--border);
  background: var(--surface);
  border-radius: var(--radius-sm);
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.mobile-toggle svg { width: 18px; height: 18px; }

/* ========== HIDDEN PAGES ========== */
.page { display: none; }
.page.active { display: block; }

/* ========== CONFIRM DIALOG ========== */
.confirm-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 250;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(2px);
}
.confirm-overlay.active { display: flex; }
.confirm-dialog {
  background: var(--surface);
  border-radius: var(--radius-md);
  padding: 28px;
  max-width: 400px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  text-align: center;
}
.confirm-dialog h3 { margin-bottom: 8px; font-size: 1.05rem; }
.confirm-dialog p { font-size: 0.88rem; color: var(--text-muted); margin-bottom: 20px; }
.confirm-dialog .btn-group { display: flex; gap: 10px; justify-content: center; }
</style>
</head>
<body>

<!-- ==================== LOGIN PAGE ==================== -->
<div id="loginPage" class="login-page">
  <div class="login-card">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    </div>
    <h2>CER Builder</h2>
    <p class="login-sub">Polymath Learning Centre — Admin Portal</p>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input id="loginUser" class="form-input" type="text" placeholder="Enter username" value="admin">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input id="loginPass" class="form-input" type="password" placeholder="Enter password" value="admin123">
    </div>
    <button class="btn btn-primary" onclick="handleLogin()" style="width:100%;justify-content:center;margin-top:8px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      Sign In
    </button>
    <div id="loginError" class="login-error">Invalid username or password</div>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="appWrapper" class="app-wrapper" style="display:none;">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>CER Builder</h1>
      <span>Polymath Learning Centre</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Build</div>
      <div class="nav-item active" data-page="create" onclick="navigateTo('create')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        Create Question
      </div>
      <div class="nav-section-label">Manage</div>
      <div class="nav-item" data-page="bank" onclick="navigateTo('bank')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        Question Bank
        <span class="badge" id="bankCount">0</span>
      </div>
      <div class="nav-item" data-page="vetting" onclick="navigateTo('vetting')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Vetting List
        <span class="badge" id="vettingCount">0</span>
      </div>
      <div class="nav-section-label">Preview</div>
      <div class="nav-item" data-page="student" onclick="navigateTo('student')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Student View
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="avatar">A</div>
      <div>
        <div style="font-size:0.85rem;color:#fff;">Admin</div>
        <div style="font-size:0.72rem;color:rgba(255,255,255,0.4);">Logged in</div>
      </div>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="main-content">

    <!-- ===== PAGE: CREATE QUESTION ===== -->
    <div class="page active" id="page-create">
      <div class="page-header">
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <button class="mobile-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
            <h2>Create Question</h2>
          </div>
          <div class="subtitle">Build a CER question with blocks</div>
        </div>
      </div>
      <div class="page-body">
        <!-- Meta Fields -->
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="categorySelect" class="form-select">
              <option value="CER (Open Ended)">CER (Open Ended)</option>
              <option value="CER (Fill in Blanks)">CER (Fill in Blanks)</option>
              <option value="CER (MCQ)">CER (MCQ)</option>
              <option value="Open Ended">Open Ended</option>
              <option value="MCQ">MCQ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Question Title</label>
            <input id="questionTitle" class="form-input" type="text" placeholder="e.g. Question 1">
          </div>
          <div class="form-group">
            <label class="form-label">Topic</label>
            <select id="topicSelect" class="form-select">
              <optgroup label="── P3 ──">
                <option value="Living and non-living things">Living and non-living things</option>
                <option value="Materials">Materials</option>
                <option value="Life Cycles">Life Cycles</option>
                <option value="Magnets">Magnets</option>
              </optgroup>
              <optgroup label="── P4 ──">
                <option value="Plant Systems">Plant Systems</option>
                <option value="Human Body Systems">Human Body Systems</option>
                <option value="Matter and its 3 States">Matter and its 3 States</option>
                <option value="Light">Light</option>
                <option value="Heat" selected>Heat</option>
              </optgroup>
              <optgroup label="── P5 ──">
                <option value="Water and its 3 States">Water and its 3 States</option>
                <option value="Plant Reproduction">Plant Reproduction</option>
                <option value="Human Reproduction">Human Reproduction</option>
                <option value="Human and Plant Respiration">Human and Plant Respiration</option>
                <option value="Human and Plant Transport">Human and Plant Transport</option>
                <option value="Electrical Systems">Electrical Systems</option>
              </optgroup>
              <optgroup label="── P6 ──">
                <option value="Forces">Forces</option>
                <option value="Energy in Food">Energy in Food</option>
                <option value="Energy Conversion">Energy Conversion</option>
                <option value="Living Together">Living Together</option>
                <option value="Food Chains and Webs">Food Chains and Webs</option>
                <option value="Humans and the Environment">Humans and the Environment</option>
              </optgroup>
              <optgroup label="── Custom ──">
                <option value="__custom__">+ Add Custom Topic</option>
              </optgroup>
            </select>
          </div>
        </div>

        <!-- Blocks List -->
        <div class="blocks-container">
          <div class="blocks-list" id="blocksList">
            <!-- blocks rendered here -->
          </div>

          <!-- Add Block Buttons -->
          <div class="add-block-row">
            <button class="add-block-btn text-add" onclick="addBlock('text')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Text
            </button>
            <button class="add-block-btn answer-add" onclick="addBlock('answer')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Answer
            </button>
            <button class="add-block-btn explanation-add" onclick="addBlock('explanation')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Explanation
            </button>
            <button class="add-block-btn video-add" onclick="addBlock('video')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Video URL
            </button>
            <button class="add-block-btn image-add" onclick="addBlock('image')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Image URL
            </button>
            <button class="add-block-btn table-add" onclick="addBlock('table')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
              Add Table
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-row">
          <button class="btn btn-danger" onclick="clearForm()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Clear Form
          </button>
          <button class="btn btn-orange" onclick="openPreview()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            Preview & Select Blanks
          </button>
          <button class="btn btn-blue" onclick="addToVetting()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            Add to Vetting List
          </button>
          <button class="btn btn-primary" onclick="addToBank()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Add to Question Bank
          </button>
        </div>
      </div>
    </div>

    <!-- ===== PAGE: QUESTION BANK ===== -->
    <div class="page" id="page-bank">
      <div class="page-header">
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <button class="mobile-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
            <h2>Question Bank</h2>
          </div>
          <div class="subtitle">All saved questions ready for use</div>
        </div>
      </div>
      <div class="page-body" style="max-width:960px;">
        <div class="filter-bar">
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="bankSearch" placeholder="Search questions..." oninput="renderQuestionBank()">
          </div>
          <select id="bankFilterTopic" onchange="renderQuestionBank()">
            <option value="">All Topics</option>
          </select>
          <select id="bankFilterCategory" onchange="renderQuestionBank()">
            <option value="">All Categories</option>
            <option value="CER (Open Ended)">CER (Open Ended)</option>
            <option value="CER (Fill in Blanks)">CER (Fill in Blanks)</option>
            <option value="CER (MCQ)">CER (MCQ)</option>
            <option value="Open Ended">Open Ended</option>
            <option value="MCQ">MCQ</option>
          </select>
        </div>
        <div class="question-bank-grid" id="questionBankGrid"></div>
      </div>
    </div>

    <!-- ===== PAGE: VETTING LIST ===== -->
    <div class="page" id="page-vetting">
      <div class="page-header">
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <button class="mobile-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
            <h2>Vetting List</h2>
          </div>
          <div class="subtitle">Questions pending review before adding to the bank</div>
        </div>
      </div>
      <div class="page-body" style="max-width:960px;">
        <div class="question-bank-grid" id="vettingListGrid"></div>
      </div>
    </div>

    <!-- ===== PAGE: STUDENT VIEW ===== -->
    <div class="page" id="page-student">
      <div class="page-header">
        <div>
          <div style="display:flex;align-items:center;gap:10px;">
            <button class="mobile-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
            <h2>Student View</h2>
          </div>
          <div class="subtitle">Preview how students see the questions with blanks</div>
        </div>
        <div>
          <select id="studentQuestionSelect" class="form-select" onchange="renderStudentView()" style="min-width:220px;">
            <option value="">Select a question...</option>
          </select>
        </div>
      </div>
      <div class="page-body" style="max-width:780px;">
        <div id="studentViewContainer"></div>
      </div>
    </div>

  </div>
</div>

<!-- ==================== PREVIEW OVERLAY ==================== -->
<div class="preview-overlay" id="previewOverlay">
  <div class="preview-panel">
    <div class="preview-header">
      <h3>Interactive Preview</h3>
      <button class="preview-close" onclick="closePreview()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="preview-toolbar">
      <span class="hint">Click on words to convert them to blanks. Bolded words will become fill-in-the-blank fields for students.</span>
      <span class="blank-count" id="blankCountBadge">0 blanks</span>
    </div>
    <div class="preview-body" id="previewBody"></div>
    <div style="padding:0 28px 20px;display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-outline" onclick="clearAllBlanks()">Clear All Blanks</button>
      <button class="btn btn-primary" onclick="confirmBlanks()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        Confirm Blanks
      </button>
    </div>
  </div>
</div>

<!-- ==================== CONFIRM DIALOG ==================== -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-dialog">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmMessage">This action cannot be undone.</p>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" id="confirmAction" onclick="closeConfirm()">Delete</button>
    </div>
  </div>
</div>

<!-- ==================== TOAST CONTAINER ==================== -->
<div class="toast-container" id="toastContainer"></div>

<script>
// =====================================================================
// STATE MANAGEMENT
// =====================================================================
let currentUser = null;
let blocks = [];
let blockIdCounter = 0;
let questionBank = [];
let vettingList = [];
let selectedBlanks = {}; // { blockId: { wordIndex: true } }
let currentEditingQuestion = null;

const USERS = {
  admin: { password: 'admin123', name: 'Admin', role: 'admin' },
  teacher: { password: 'teach123', name: 'Teacher', role: 'teacher' }
};

// =====================================================================
// LOGIN
// =====================================================================
function handleLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (USERS[user] && USERS[user].password === pass) {
    currentUser = { username: user, ...USERS[user] };
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appWrapper').style.display = 'flex';
    document.querySelector('.avatar').textContent = currentUser.name[0];
    document.querySelector('.sidebar-footer div div:first-child').textContent = currentUser.name;
    loadFromStorage();
    showToast('Welcome back, ' + currentUser.name + '!', 'success');
  } else {
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => { document.getElementById('loginError').style.display = 'none'; }, 3000);
  }
}

// =====================================================================
// NAVIGATION
// =====================================================================
function navigateTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
  if (page === 'bank') renderQuestionBank();
  if (page === 'vetting') renderVettingList();
  if (page === 'student') {
    populateStudentSelect();
    renderStudentView();
  }
  // close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// =====================================================================
// TOPIC CUSTOM HANDLER
// =====================================================================
document.getElementById('topicSelect').addEventListener('change', function() {
  if (this.value === '__custom__') {
    const custom = prompt('Enter custom topic name:');
    if (custom && custom.trim()) {
      const opt = document.createElement('option');
      opt.value = custom.trim();
      opt.textContent = custom.trim();
      const customGroup = this.querySelector('optgroup[label="── Custom ──"]');
      customGroup.insertBefore(opt, customGroup.querySelector('option[value="__custom__"]'));
      this.value = custom.trim();
    } else {
      this.value = 'Heat';
    }
  }
});

// =====================================================================
// BLOCK MANAGEMENT
// =====================================================================
function generateBlockId() {
  return 'block_' + (++blockIdCounter) + '_' + Date.now();
}

function addBlock(type) {
  const id = generateBlockId();
  const block = { id, type };
  
  switch (type) {
    case 'text':
      block.content = '';
      break;
    case 'image':
      block.url = '';
      break;
    case 'answer':
      block.claim = '';
      block.evidence = '';
      block.reasoning = '';
      break;
    case 'explanation':
      block.content = '';
      break;
    case 'video':
      block.url = '';
      break;
    case 'table':
      block.rows = 3;
      block.cols = 2;
      block.data = Array.from({ length: 3 }, () => Array.from({ length: 2 }, () => ''));
      block.headers = Array.from({ length: 2 }, () => '');
      break;
  }
  
  blocks.push(block);
  renderBlocks();
  showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} block added`, 'info');
}

function removeBlock(id) {
  blocks = blocks.filter(b => b.id !== id);
  if (selectedBlanks[id]) delete selectedBlanks[id];
  renderBlocks();
}

function moveBlock(id, direction) {
  const idx = blocks.findIndex(b => b.id === id);
  if (direction === 'up' && idx > 0) {
    [blocks[idx], blocks[idx - 1]] = [blocks[idx - 1], blocks[idx]];
  } else if (direction === 'down' && idx < blocks.length - 1) {
    [blocks[idx], blocks[idx + 1]] = [blocks[idx + 1], blocks[idx]];
  }
  renderBlocks();
}

function duplicateBlock(id) {
  const original = blocks.find(b => b.id === id);
  if (!original) return;
  const clone = JSON.parse(JSON.stringify(original));
  clone.id = generateBlockId();
  const idx = blocks.findIndex(b => b.id === id);
  blocks.splice(idx + 1, 0, clone);
  renderBlocks();
  showToast('Block duplicated', 'info');
}

function saveBlockContent(id, field, value) {
  const block = blocks.find(b => b.id === id);
  if (block) {
    if (field.startsWith('cell_')) {
      const parts = field.split('_');
      const r = parseInt(parts[1]);
      const c = parseInt(parts[2]);
      block.data[r][c] = value;
    } else if (field.startsWith('header_')) {
      const c = parseInt(field.split('_')[1]);
      block.headers[c] = value;
    } else {
      block[field] = value;
    }
  }
}

function updateTableDimensions(id, dimension, value) {
  const block = blocks.find(b => b.id === id);
  if (!block || block.type !== 'table') return;
  
  const num = Math.max(1, Math.min(20, parseInt(value) || 1));
  
  if (dimension === 'rows') {
    const diff = num - block.rows;
    if (diff > 0) {
      for (let i = 0; i < diff; i++) {
        block.data.push(Array.from({ length: block.cols }, () => ''));
      }
    } else if (diff < 0) {
      block.data = block.data.slice(0, num);
    }
    block.rows = num;
  } else if (dimension === 'cols') {
    const diff = num - block.cols;
    if (diff > 0) {
      block.headers = [...block.headers, ...Array.from({ length: diff }, () => '')];
      block.data = block.data.map(row => [...row, ...Array.from({ length: diff }, () => '')]);
    } else if (diff < 0) {
      block.headers = block.headers.slice(0, num);
      block.data = block.data.map(row => row.slice(0, num));
    }
    block.cols = num;
  }
  
  renderBlocks();
}

// =====================================================================
// RENDER BLOCKS
// =====================================================================
function renderBlocks() {
  const container = document.getElementById('blocksList');
  container.innerHTML = '';
  
  blocks.forEach((block, index) => {
    const card = document.createElement('div');
    card.className = 'block-card';
    card.dataset.id = block.id;
    card.draggable = true;
    
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragover', handleDragOver);
    card.addEventListener('drop', handleDrop);
    card.addEventListener('dragend', handleDragEnd);
    
    let badgeClass = '', badgeIcon = '', badgeLabel = '';
    switch (block.type) {
      case 'text':
        badgeClass = 'text-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>';
        badgeLabel = 'Text Block';
        break;
      case 'image':
        badgeClass = 'image-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
        badgeLabel = 'Image Block';
        break;
      case 'answer':
        badgeClass = 'answer-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        badgeLabel = 'Answer Block (CER)';
        break;
      case 'explanation':
        badgeClass = 'explanation-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
        badgeLabel = 'Explanation';
        break;
      case 'video':
        badgeClass = 'video-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>';
        badgeLabel = 'Video URL';
        break;
      case 'table':
        badgeClass = 'table-badge';
        badgeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>';
        badgeLabel = 'Table Block';
        break;
    }
    
    let bodyHTML = '';
    
    switch (block.type) {
      case 'text':
        bodyHTML = `
          <div class="text-toolbar">
            <button class="toolbar-btn" title="Bold" onmousedown="event.preventDefault();execCmd('bold')"><b>B</b></button>
            <button class="toolbar-btn" title="Italic" onmousedown="event.preventDefault();execCmd('italic')"><i>I</i></button>
            <button class="toolbar-btn" title="Underline" onmousedown="event.preventDefault();execCmd('underline')"><u>U</u></button>
            <button class="toolbar-btn" title="Superscript" onmousedown="event.preventDefault();execCmd('superscript')" style="font-size:0.72rem;">X<sup>2</sup></button>
            <button class="toolbar-btn" title="Subscript" onmousedown="event.preventDefault();execCmd('subscript')" style="font-size:0.72rem;">X<sub>2</sub></button>
            <span class="toolbar-divider"></span>
            <button class="toolbar-btn" title="Ordered List" onmousedown="event.preventDefault();execCmd('insertOrderedList')">⊞</button>
            <span class="toolbar-divider"></span>
            <button class="toolbar-btn" title="Align Left" onmousedown="event.preventDefault();execCmd('justifyLeft')">≡</button>
            <button class="toolbar-btn" title="Align Center" onmousedown="event.preventDefault();execCmd('justifyCenter')">≡</button>
            <button class="toolbar-btn" title="Align Right" onmousedown="event.preventDefault();execCmd('justifyRight')">≡</button>
            <button class="toolbar-btn" title="Justify" onmousedown="event.preventDefault();execCmd('justifyFull')">≡</button>
            <span class="toolbar-divider"></span>
            <button class="toolbar-btn" title="Indent" onmousedown="event.preventDefault();execCmd('indent')">→</button>
            <button class="toolbar-btn" title="Outdent" onmousedown="event.preventDefault();execCmd('outdent')">←</button>
            <span class="toolbar-divider"></span>
            <select class="toolbar-select" onchange="execCmdVal('formatBlock', this.value); this.value='';">
              <option value="">List Style</option>
              <option value="h3">Heading</option>
              <option value="p">Normal</option>
            </select>
          </div>
          <div class="content-editable" contenteditable="true" data-placeholder="Enter question text..."
               data-block-id="${block.id}" data-field="content"
               oninput="saveBlockContent('${block.id}', 'content', this.innerHTML)">${block.content}</div>
        `;
        break;
        
      case 'image':
        bodyHTML = `
          <div class="block-body">
            <div class="image-url-input">
              <input class="form-input" type="text" placeholder="https://www.example.com/image.png" 
                     value="${escapeHtml(block.url)}"
                     oninput="saveBlockContent('${block.id}', 'url', this.value); previewImage('${block.id}', this.value)">
            </div>
            <div class="image-preview" id="imgPreview_${block.id}">
              ${block.url ? `<img src="${escapeHtml(transformImageUrl(block.url))}" onerror="this.parentElement.innerHTML='<div class=\\'image-error\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\'><circle cx=\\'12\\' cy=\\'12\\' r=\\'10\\'/><line x1=\\'15\\' y1=\\'9\\' x2=\\'9\\' y2=\\'15\\'/><line x1=\\'9\\' y1=\\'9\\' x2=\\'15\\' y2=\\'15\\'/></svg><div>Image failed to load</div></div>'">` : '<div class="image-error">No image URL provided</div>'}
            </div>
          </div>
        `;
        break;
        
      case 'answer':
        bodyHTML = `
          <div class="block-body">
            <div class="cer-section">
              <div class="cer-label claim-label">Claim</div>
              <textarea class="cer-textarea" placeholder="Enter the claim answer..."
                        oninput="saveBlockContent('${block.id}', 'claim', this.value)">${escapeHtml(block.claim)}</textarea>
            </div>
            <div class="cer-section">
              <div class="cer-label evidence-label">Evidence</div>
              <textarea class="cer-textarea" placeholder="Enter the evidence answer..."
                        oninput="saveBlockContent('${block.id}', 'evidence', this.value)">${escapeHtml(block.evidence)}</textarea>
            </div>
            <div class="cer-section">
              <div class="cer-label reasoning-label">Reasoning</div>
              <textarea class="cer-textarea" placeholder="Enter the reasoning answer..."
                        oninput="saveBlockContent('${block.id}', 'reasoning', this.value)">${escapeHtml(block.reasoning)}</textarea>
            </div>
          </div>
        `;
        break;
        
      case 'explanation':
        bodyHTML = `
          <div class="text-toolbar">
            <button class="toolbar-btn" title="Bold" onmousedown="event.preventDefault();execCmd('bold')"><b>B</b></button>
            <button class="toolbar-btn" title="Italic" onmousedown="event.preventDefault();execCmd('italic')"><i>I</i></button>
            <button class="toolbar-btn" title="Underline" onmousedown="event.preventDefault();execCmd('underline')"><u>U</u></button>
            <button class="toolbar-btn" title="Superscript" onmousedown="event.preventDefault();execCmd('superscript')" style="font-size:0.72rem;">X<sup>2</sup></button>
            <button class="toolbar-btn" title="Subscript" onmousedown="event.preventDefault();execCmd('subscript')" style="font-size:0.72rem;">X<sub>2</sub></button>
            <span class="toolbar-divider"></span>
            <select class="toolbar-select" onchange="execCmdVal('formatBlock', this.value); this.value='';">
              <option value="">List Style</option>
              <option value="h3">Heading</option>
              <option value="p">Normal</option>
            </select>
          </div>
          <div class="content-editable" contenteditable="true" data-placeholder="Enter explanation text..."
               data-block-id="${block.id}" data-field="content"
               oninput="saveBlockContent('${block.id}', 'content', this.innerHTML)">${block.content || ''}</div>
        `;
        break;
        
      case 'video':
        bodyHTML = `
          <div class="block-body">
            <div class="image-url-input">
              <input class="form-input" type="text" placeholder="https://www.youtube.com/watch?v=..."
                     value="${escapeHtml(block.url)}"
                     oninput="saveBlockContent('${block.id}', 'url', this.value)">
            </div>
          </div>
        `;
        break;
        
      case 'table':
        let tableHTML = `
          <div class="block-body">
            <div class="table-controls">
              <label>Rows:</label>
              <input type="number" value="${block.rows}" min="1" max="20" 
                     onchange="updateTableDimensions('${block.id}', 'rows', this.value)">
              <label>Columns:</label>
              <input type="number" value="${block.cols}" min="1" max="10"
                     onchange="updateTableDimensions('${block.id}', 'cols', this.value)">
            </div>
            <table class="editable-table">
              <thead><tr>`;
        for (let c = 0; c < block.cols; c++) {
          tableHTML += `<th contenteditable="true" 
                            oninput="saveBlockContent('${block.id}', 'header_${c}', this.textContent)">${escapeHtml(block.headers[c] || '')}</th>`;
        }
        tableHTML += `</tr></thead><tbody>`;
        for (let r = 0; r < block.rows; r++) {
          tableHTML += '<tr>';
          for (let c = 0; c < block.cols; c++) {
            tableHTML += `<td contenteditable="true"
                             oninput="saveBlockContent('${block.id}', 'cell_${r}_${c}', this.textContent)">${escapeHtml(block.data[r]?.[c] || '')}</td>`;
          }
          tableHTML += '</tr>';
        }
        tableHTML += `</tbody></table></div>`;
        bodyHTML = tableHTML;
        break;
    }
    
    card.innerHTML = `
      <div class="block-header">
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="drag-handle" title="Drag to reorder">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="5" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/><circle cx="15" cy="19" r="1.5"/></svg>
          </div>
          <span class="block-type-badge ${badgeClass}">${badgeIcon} ${badgeLabel}</span>
        </div>
        <div class="block-actions">
          <button class="block-action-btn" title="Move Up" onclick="moveBlock('${block.id}', 'up')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
          </button>
          <button class="block-action-btn" title="Move Down" onclick="moveBlock('${block.id}', 'down')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <button class="block-action-btn" title="Duplicate" onclick="duplicateBlock('${block.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
          <button class="block-action-btn delete" title="Delete" onclick="removeBlock('${block.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>
      </div>
      ${bodyHTML}
    `;
    
    container.appendChild(card);
  });
}

// =====================================================================
// RICH TEXT COMMANDS
// =====================================================================
function execCmd(cmd) {
  document.execCommand(cmd, false, null);
}
function execCmdVal(cmd, val) {
  if (val) document.execCommand(cmd, false, val);
}

// =====================================================================
// IMAGE PREVIEW
// =====================================================================
function previewImage(blockId, url) {
  const container = document.getElementById('imgPreview_' + blockId);
  if (!container) return;
  if (!url.trim()) {
    container.innerHTML = '<div class="image-error">No image URL provided</div>';
    return;
  }
  container.innerHTML = `<img src="${escapeHtml(transformImageUrl(url))}" onerror="this.parentElement.innerHTML='<div class=\\'image-error\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\'><circle cx=\\'12\\' cy=\\'12\\' r=\\'10\\'/><line x1=\\'15\\' y1=\\'9\\' x2=\\'9\\' y2=\\'15\\'/><line x1=\\'9\\' y1=\\'9\\' x2=\\'15\\' y2=\\'15\\'/></svg><div>Image failed to load</div></div>'">`;
}

// =====================================================================
// DRAG AND DROP
// =====================================================================
let draggedBlockId = null;

function handleDragStart(e) {
  draggedBlockId = this.dataset.id;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDrop(e) {
  e.preventDefault();
  const targetId = this.dataset.id;
  if (draggedBlockId && draggedBlockId !== targetId) {
    const fromIdx = blocks.findIndex(b => b.id === draggedBlockId);
    const toIdx = blocks.findIndex(b => b.id === targetId);
    const [moved] = blocks.splice(fromIdx, 1);
    blocks.splice(toIdx, 0, moved);
    renderBlocks();
  }
}

function handleDragEnd() {
  this.classList.remove('dragging');
  draggedBlockId = null;
}

// =====================================================================
// PREVIEW & SELECT BLANKS
// =====================================================================
function openPreview() {
  if (blocks.length === 0) {
    showToast('Add some blocks first before previewing', 'error');
    return;
  }
  
  const title = document.getElementById('questionTitle').value || 'Untitled Question';
  const category = document.getElementById('categorySelect').value;
  const topic = document.getElementById('topicSelect').value;
  
  let html = '';
  html += `<div class="preview-question-title">${escapeHtml(title)}</div>`;
  html += `<div class="preview-meta">
    <span class="tag">${escapeHtml(category)}</span>
    <span class="tag">${escapeHtml(topic)}</span>
  </div>`;
  html += `<div class="preview-content">`;
  
  blocks.forEach(block => {
    switch (block.type) {
      case 'text':
        html += renderSelectableText(block.id, block.content, 'text');
        break;
      case 'image':
        if (block.url) {
          html += `<div style="margin:14px 0;">
            <img src="${escapeHtml(transformImageUrl(block.url))}" onerror="this.style.display='none'" style="max-width:100%;border-radius:8px;border:1px solid var(--border);">
          </div>`;
        }
        break;
      case 'answer':
        html += `<div class="cer-preview-section">`;
        html += `<div class="cer-preview-label claim-bg">Claim</div>`;
        html += `<div class="cer-preview-content">${renderSelectableText(block.id + '_claim', block.claim, 'claim')}</div>`;
        html += `</div>`;
        html += `<div class="cer-preview-section">`;
        html += `<div class="cer-preview-label evidence-bg">Evidence</div>`;
        html += `<div class="cer-preview-content">${renderSelectableText(block.id + '_evidence', block.evidence, 'evidence')}</div>`;
        html += `</div>`;
        html += `<div class="cer-preview-section">`;
        html += `<div class="cer-preview-label reasoning-bg">Reasoning</div>`;
        html += `<div class="cer-preview-content">${renderSelectableText(block.id + '_reasoning', block.reasoning, 'reasoning')}</div>`;
        html += `</div>`;
        break;
      case 'explanation':
        html += `<div class="explanation-preview">
          <div class="exp-label">Explanation</div>
          ${renderSelectableText(block.id, block.content, 'explanation')}
        </div>`;
        break;
      case 'video':
        if (block.url) {
          const embedUrl = getYouTubeEmbedUrl(block.url);
          if (embedUrl) {
            html += `<div class="video-embed"><iframe src="${embedUrl}" allowfullscreen></iframe></div>`;
          } else {
            html += `<div class="video-url-display">Video: ${escapeHtml(block.url)}</div>`;
          }
        }
        break;
      case 'table':
        html += '<table>';
        html += '<thead><tr>';
        for (let c = 0; c < block.cols; c++) {
          html += `<th>${escapeHtml(block.headers[c] || '')}</th>`;
        }
        html += '</tr></thead><tbody>';
        for (let r = 0; r < block.rows; r++) {
          html += '<tr>';
          for (let c = 0; c < block.cols; c++) {
            html += `<td>${escapeHtml(block.data[r]?.[c] || '')}</td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
        break;
    }
  });
  
  html += `</div>`;
  
  document.getElementById('previewBody').innerHTML = html;
  document.getElementById('previewOverlay').classList.add('active');
  updateBlankCount();
}

function renderSelectableText(blockId, content, sectionType) {
  if (!content) return '';
  
  // Strip HTML tags for word tokenization but keep structure
  const textOnly = content.replace(/<[^>]*>/g, ' ').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
  if (!textOnly) return '';
  
  const words = textOnly.split(/\s+/);
  let html = '<div style="line-height:2;">';
  
  words.forEach((word, idx) => {
    const key = blockId + '_' + idx;
    const isBlanked = selectedBlanks[blockId] && selectedBlanks[blockId][idx];
    html += `<span class="selectable-word${isBlanked ? ' blanked' : ''}" 
                  data-block="${blockId}" data-word-index="${idx}"
                  onclick="toggleBlank('${blockId}', ${idx}, this)">${escapeHtml(word)}</span> `;
  });
  
  html += '</div>';
  return html;
}

function toggleBlank(blockId, wordIndex, el) {
  if (!selectedBlanks[blockId]) selectedBlanks[blockId] = {};
  
  if (selectedBlanks[blockId][wordIndex]) {
    delete selectedBlanks[blockId][wordIndex];
    el.classList.remove('blanked');
  } else {
    selectedBlanks[blockId][wordIndex] = true;
    el.classList.add('blanked');
  }
  
  updateBlankCount();
}

function clearAllBlanks() {
  selectedBlanks = {};
  document.querySelectorAll('.selectable-word.blanked').forEach(el => el.classList.remove('blanked'));
  updateBlankCount();
  showToast('All blanks cleared', 'info');
}

function updateBlankCount() {
  let count = 0;
  Object.values(selectedBlanks).forEach(blk => {
    count += Object.keys(blk).length;
  });
  document.getElementById('blankCountBadge').textContent = count + ' blank' + (count !== 1 ? 's' : '');
}

function confirmBlanks() {
  closePreview();
  const count = Object.values(selectedBlanks).reduce((sum, blk) => sum + Object.keys(blk).length, 0);
  showToast(`${count} blank(s) confirmed for this question`, 'success');
}

function closePreview() {
  document.getElementById('previewOverlay').classList.remove('active');
}

function getYouTubeEmbedUrl(url) {
  if (!url) return null;
  const regex = /(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
  const match = url.match(regex);
  return match ? `https://www.youtube.com/embed/${match[1]}` : null;
}

function transformImageUrl(url) {
  if (!url) return url;
  try {
    const u = new URL(url);
    if (u.hostname.endsWith('dropbox.com') && u.hostname !== 'dl.dropboxusercontent.com') {
      u.hostname = 'dl.dropboxusercontent.com';
      u.searchParams.delete('dl');
      return u.toString();
    }
  } catch (e) {}
  return url;
}

// =====================================================================
// SAVE / LOAD QUESTION
// =====================================================================
function collectQuestionData() {
  // Sync contenteditable blocks
  document.querySelectorAll('.content-editable[data-block-id]').forEach(el => {
    const bid = el.dataset.blockId;
    const field = el.dataset.field;
    const block = blocks.find(b => b.id === bid);
    if (block) block[field] = el.innerHTML;
  });
  
  return {
    id: 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
    title: document.getElementById('questionTitle').value || 'Untitled',
    category: document.getElementById('categorySelect').value,
    topic: document.getElementById('topicSelect').value,
    blocks: JSON.parse(JSON.stringify(blocks)),
    blanks: JSON.parse(JSON.stringify(selectedBlanks)),
    createdAt: new Date().toISOString(),
    createdBy: currentUser?.name || 'Admin'
  };
}

function addToBank() {
  if (blocks.length === 0) {
    showToast('Add some blocks before saving', 'error');
    return;
  }
  const q = collectQuestionData();
  if (currentEditingQuestion) {
    const idx = questionBank.findIndex(qb => qb.id === currentEditingQuestion);
    if (idx !== -1) {
      q.id = currentEditingQuestion;
      questionBank[idx] = q;
      showToast('Question updated in bank', 'success');
    } else {
      questionBank.push(q);
      showToast('Question added to bank', 'success');
    }
    currentEditingQuestion = null;
  } else {
    questionBank.push(q);
    showToast('Question added to bank', 'success');
  }
  updateCounts();
  saveToStorage();
}

function addToVetting() {
  if (blocks.length === 0) {
    showToast('Add some blocks before saving', 'error');
    return;
  }
  const q = collectQuestionData();
  q.status = 'pending';
  vettingList.push(q);
  updateCounts();
  saveToStorage();
  showToast('Question added to vetting list', 'success');
}

function clearForm() {
  showConfirm('Clear Form', 'This will remove all blocks and reset the form. Are you sure?', () => {
    blocks = [];
    selectedBlanks = {};
    currentEditingQuestion = null;
    document.getElementById('questionTitle').value = '';
    document.getElementById('categorySelect').value = 'CER (Open Ended)';
    document.getElementById('topicSelect').value = 'Heat';
    renderBlocks();
    showToast('Form cleared', 'info');
  });
}

// =====================================================================
// QUESTION BANK RENDERING
// =====================================================================
function renderQuestionBank() {
  const container = document.getElementById('questionBankGrid');
  const search = (document.getElementById('bankSearch')?.value || '').toLowerCase();
  const topicFilter = document.getElementById('bankFilterTopic')?.value || '';
  const catFilter = document.getElementById('bankFilterCategory')?.value || '';
  
  let filtered = questionBank.filter(q => {
    if (search && !q.title.toLowerCase().includes(search) && !q.topic.toLowerCase().includes(search)) return false;
    if (topicFilter && q.topic !== topicFilter) return false;
    if (catFilter && q.category !== catFilter) return false;
    return true;
  });
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        <h3>No questions yet</h3>
        <p>Create your first CER question to get started</p>
      </div>`;
    return;
  }
  
  container.innerHTML = filtered.map(q => {
    const blankCount = Object.values(q.blanks || {}).reduce((sum, blk) => sum + Object.keys(blk).length, 0);
    const preview = getQuestionPreview(q);
    return `
      <div class="qb-card" ondblclick="editQuestion('${q.id}')">
        <div class="qb-card-header">
          <div>
            <div class="qb-card-title">${escapeHtml(q.title)}</div>
            <div class="qb-card-meta">
              <span class="qb-tag category">${escapeHtml(q.category)}</span>
              <span class="qb-tag topic">${escapeHtml(q.topic)}</span>
              ${blankCount > 0 ? `<span class="qb-tag blanks">${blankCount} blank${blankCount !== 1 ? 's' : ''}</span>` : ''}
            </div>
          </div>
          <div class="qb-card-actions">
            <button class="qb-action-btn" title="Edit" onclick="event.stopPropagation();editQuestion('${q.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="qb-action-btn" title="Duplicate" onclick="event.stopPropagation();duplicateQuestion('${q.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            </button>
            <button class="qb-action-btn delete-qb" title="Delete" onclick="event.stopPropagation();deleteQuestion('${q.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
        <div class="qb-card-preview">${escapeHtml(preview)}</div>
      </div>`;
  }).join('');
}

function getQuestionPreview(q) {
  for (const block of q.blocks) {
    if (block.type === 'text' && block.content) {
      return block.content.replace(/<[^>]*>/g, ' ').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim().substring(0, 150);
    }
  }
  return 'No text content';
}

function editQuestion(id) {
  const q = questionBank.find(qb => qb.id === id) || vettingList.find(v => v.id === id);
  if (!q) return;
  
  currentEditingQuestion = q.id;
  document.getElementById('questionTitle').value = q.title;
  document.getElementById('categorySelect').value = q.category;
  
  // Try to set topic, handle custom topics
  const topicSelect = document.getElementById('topicSelect');
  const existingOption = Array.from(topicSelect.options).find(opt => opt.value === q.topic);
  if (!existingOption) {
    const customGroup = topicSelect.querySelector('optgroup[label="── Custom ──"]');
    const opt = document.createElement('option');
    opt.value = q.topic;
    opt.textContent = q.topic;
    customGroup.insertBefore(opt, customGroup.querySelector('option[value="__custom__"]'));
  }
  topicSelect.value = q.topic;
  
  blocks = JSON.parse(JSON.stringify(q.blocks));
  selectedBlanks = JSON.parse(JSON.stringify(q.blanks || {}));
  
  renderBlocks();
  navigateTo('create');
  showToast('Editing: ' + q.title, 'info');
}

function duplicateQuestion(id) {
  const q = questionBank.find(qb => qb.id === id);
  if (!q) return;
  const clone = JSON.parse(JSON.stringify(q));
  clone.id = 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
  clone.title = q.title + ' (Copy)';
  clone.createdAt = new Date().toISOString();
  questionBank.push(clone);
  saveToStorage();
  renderQuestionBank();
  updateCounts();
  showToast('Question duplicated', 'success');
}

function deleteQuestion(id) {
  showConfirm('Delete Question', 'Are you sure you want to permanently delete this question?', () => {
    questionBank = questionBank.filter(q => q.id !== id);
    saveToStorage();
    renderQuestionBank();
    updateCounts();
    showToast('Question deleted', 'info');
  });
}

// =====================================================================
// VETTING LIST
// =====================================================================
function renderVettingList() {
  const container = document.getElementById('vettingListGrid');
  
  if (vettingList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        <h3>Vetting list is empty</h3>
        <p>Questions added for review will appear here</p>
      </div>`;
    return;
  }
  
  container.innerHTML = vettingList.map(q => {
    const statusClass = q.status || 'pending';
    const preview = getQuestionPreview(q);
    return `
      <div class="qb-card">
        <div class="qb-card-header">
          <div>
            <div class="qb-card-title">${escapeHtml(q.title)}</div>
            <div class="qb-card-meta">
              <span class="qb-tag category">${escapeHtml(q.category)}</span>
              <span class="qb-tag topic">${escapeHtml(q.topic)}</span>
              <span class="vetting-badge ${statusClass}">${statusClass.charAt(0).toUpperCase() + statusClass.slice(1)}</span>
            </div>
          </div>
          <div class="qb-card-actions">
            <button class="qb-action-btn" title="Approve & Add to Bank" onclick="approveVetting('${q.id}')" style="color:var(--primary);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            </button>
            <button class="qb-action-btn" title="Edit" onclick="editQuestion('${q.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="qb-action-btn delete-qb" title="Delete" onclick="deleteVetting('${q.id}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
        <div class="qb-card-preview">${escapeHtml(preview)}</div>
      </div>`;
  }).join('');
}

function approveVetting(id) {
  const idx = vettingList.findIndex(q => q.id === id);
  if (idx === -1) return;
  const q = vettingList[idx];
  q.status = 'approved';
  questionBank.push(q);
  vettingList.splice(idx, 1);
  saveToStorage();
  renderVettingList();
  updateCounts();
  showToast('Question approved and added to bank', 'success');
}

function deleteVetting(id) {
  showConfirm('Delete from Vetting', 'Remove this question from the vetting list?', () => {
    vettingList = vettingList.filter(q => q.id !== id);
    saveToStorage();
    renderVettingList();
    updateCounts();
    showToast('Question removed from vetting list', 'info');
  });
}

// =====================================================================
// STUDENT VIEW
// =====================================================================
function populateStudentSelect() {
  const sel = document.getElementById('studentQuestionSelect');
  const currentVal = sel.value;
  sel.innerHTML = '<option value="">Select a question...</option>';
  questionBank.forEach(q => {
    const opt = document.createElement('option');
    opt.value = q.id;
    opt.textContent = q.title + ' — ' + q.topic;
    sel.appendChild(opt);
  });
  if (currentVal) sel.value = currentVal;
}

function renderStudentView() {
  const container = document.getElementById('studentViewContainer');
  const qId = document.getElementById('studentQuestionSelect').value;
  
  if (!qId) {
    container.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        <h3>Select a Question</h3>
        <p>Choose a question from the dropdown above to see the student view</p>
      </div>`;
    return;
  }
  
  const q = questionBank.find(qb => qb.id === qId);
  if (!q) return;
  
  let html = `<div class="student-view-card">`;
  html += `<div class="student-card-header">
    <h3>${escapeHtml(q.title)}</h3>
    <div style="display:flex;gap:8px;">
      <span class="qb-tag category">${escapeHtml(q.category)}</span>
      <span class="qb-tag topic">${escapeHtml(q.topic)}</span>
    </div>
  </div>`;
  html += `<div class="student-card-body">`;
  
  q.blocks.forEach(block => {
    switch (block.type) {
      case 'text':
        html += renderStudentText(block.id, block.content, q.blanks);
        break;
      case 'image':
        if (block.url) {
          html += `<div style="margin:12px 0;"><img src="${escapeHtml(transformImageUrl(block.url))}" onerror="this.style.display='none'" style="max-width:100%;border-radius:8px;border:1px solid var(--border);"></div>`;
        }
        break;
      case 'answer':
        // Claim
        html += `<div class="cer-student-section">`;
        html += `<div class="cer-student-label claim-bg" style="background:var(--accent-blue-light);color:var(--accent-blue);">Claim</div>`;
        html += `<div class="cer-student-content">${renderStudentText(block.id + '_claim', block.claim, q.blanks)}</div>`;
        html += `</div>`;
        // Evidence
        html += `<div class="cer-student-section">`;
        html += `<div class="cer-student-label evidence-bg" style="background:var(--accent-orange-light);color:var(--accent-orange);">Evidence</div>`;
        html += `<div class="cer-student-content">${renderStudentText(block.id + '_evidence', block.evidence, q.blanks)}</div>`;
        html += `</div>`;
        // Reasoning
        html += `<div class="cer-student-section">`;
        html += `<div class="cer-student-label reasoning-bg" style="background:var(--primary-light);color:var(--primary);">Reasoning</div>`;
        html += `<div class="cer-student-content">${renderStudentText(block.id + '_reasoning', block.reasoning, q.blanks)}</div>`;
        html += `</div>`;
        break;
      case 'explanation':
        // Hidden from students by default
        break;
      case 'video':
        if (block.url) {
          const embedUrl = getYouTubeEmbedUrl(block.url);
          if (embedUrl) {
            html += `<div class="video-embed"><iframe src="${embedUrl}" allowfullscreen></iframe></div>`;
          }
        }
        break;
      case 'table':
        html += '<table>';
        html += '<thead><tr>';
        for (let c = 0; c < block.cols; c++) {
          html += `<th>${escapeHtml(block.headers[c] || '')}</th>`;
        }
        html += '</tr></thead><tbody>';
        for (let r = 0; r < block.rows; r++) {
          html += '<tr>';
          for (let c = 0; c < block.cols; c++) {
            html += `<td>${escapeHtml(block.data[r]?.[c] || '')}</td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
        break;
    }
  });
  
  html += `</div></div>`;
  
  // Submit button
  html += `<div class="submit-row">
    <button class="btn btn-outline" onclick="resetStudentAnswers()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
      Reset
    </button>
    <button class="btn btn-primary" onclick="checkStudentAnswers('${qId}')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      Check Answers
    </button>
  </div>`;
  
  container.innerHTML = html;
}

function renderStudentText(blockId, content, blanks) {
  if (!content) return '';
  
  const textOnly = content.replace(/<[^>]*>/g, ' ').replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
  if (!textOnly) return '';
  
  const words = textOnly.split(/\s+/);
  const blockBlanks = blanks?.[blockId] || {};
  
  let html = '<div style="line-height:2.2;">';
  words.forEach((word, idx) => {
    if (blockBlanks[idx]) {
      html += `<input class="blank-input" data-answer="${escapeHtml(word)}" data-block="${blockId}" data-idx="${idx}" 
                      placeholder="________" style="width:${Math.max(80, word.length * 12)}px;"> `;
    } else {
      html += escapeHtml(word) + ' ';
    }
  });
  html += '</div>';
  return html;
}

function resetStudentAnswers() {
  document.querySelectorAll('.blank-input').forEach(input => {
    input.value = '';
    input.style.borderBottomColor = 'var(--primary)';
    input.style.background = 'var(--primary-light)';
  });
  showToast('Answers reset', 'info');
}

function checkStudentAnswers(qId) {
  const inputs = document.querySelectorAll('.blank-input');
  let correct = 0;
  let total = inputs.length;
  
  inputs.forEach(input => {
    const answer = input.dataset.answer.toLowerCase().trim();
    const userAnswer = input.value.toLowerCase().trim();
    
    if (userAnswer === answer) {
      input.style.borderBottomColor = 'var(--primary)';
      input.style.background = '#e8f5e9';
      correct++;
    } else if (userAnswer === '') {
      input.style.borderBottomColor = 'var(--accent-orange)';
      input.style.background = 'var(--accent-orange-light)';
    } else {
      input.style.borderBottomColor = 'var(--accent-red)';
      input.style.background = 'var(--accent-red-light)';
    }
  });
  
  if (total === 0) {
    showToast('No blanks to check in this question', 'info');
    return;
  }
  
  const pct = Math.round((correct / total) * 100);
  showToast(`Score: ${correct}/${total} (${pct}%)`, correct === total ? 'success' : 'info');
}

// =====================================================================
// STORAGE (localStorage)
// =====================================================================
function saveToStorage() {
  try {
    const data = JSON.stringify({ questionBank, vettingList });
    localStorage.setItem('cerData', data);
  } catch (e) {
    window.__cerData = { questionBank, vettingList };
  }
}

function loadFromStorage() {
  try {
    const raw = localStorage.getItem('cerData');
    if (raw) {
      const data = JSON.parse(raw);
      questionBank = data.questionBank || [];
      vettingList = data.vettingList || [];
    }
  } catch (e) {
    if (window.__cerData) {
      questionBank = window.__cerData.questionBank || [];
      vettingList = window.__cerData.vettingList || [];
    }
  }
  updateCounts();
  populateTopicFilter();
}

function updateCounts() {
  document.getElementById('bankCount').textContent = questionBank.length;
  document.getElementById('vettingCount').textContent = vettingList.length;
}

function populateTopicFilter() {
  const sel = document.getElementById('bankFilterTopic');
  if (!sel) return;
  const topics = [...new Set(questionBank.map(q => q.topic))];
  sel.innerHTML = '<option value="">All Topics</option>';
  topics.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
}

// =====================================================================
// UTILITIES
// =====================================================================
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.appendChild(document.createTextNode(str));
  return div.innerHTML;
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  
  let icon = '';
  switch (type) {
    case 'success': icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'; break;
    case 'error': icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'; break;
    default: icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
  }
  
  toast.innerHTML = icon + message;
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(30px)';
    toast.style.transition = '0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showConfirm(title, message, onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  document.getElementById('confirmOverlay').classList.add('active');
  
  const btn = document.getElementById('confirmAction');
  btn.onclick = () => {
    closeConfirm();
    onConfirm();
  };
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('active');
}

// =====================================================================
// SAMPLE DATA LOADER — adds one demo question to get started
// =====================================================================
function loadSampleData() {
  if (questionBank.length > 0) return;
  
  const sampleBlocks = [
    {
      id: 'sample_text_1',
      type: 'text',
      content: 'An experiment with two empty cups made of different materials, R and S, were placed on a table in the kitchen as shown below. An equal number of ice cubes were added into each cup at the same time.'
    },
    {
      id: 'sample_text_2',
      type: 'text',
      content: 'The line graph below shows the results of the time taken for the ice cubes to melt completely in each cup.'
    },
    {
      id: 'sample_text_3',
      type: 'text',
      content: 'Material R is the <b>temperature</b> rose slower.'
    },
    {
      id: 'sample_answer_1',
      type: 'answer',
      claim: 'Material R is a better insulator of heat than Material S.',
      evidence: 'The time taken for the temperature of cup R to increase from 0°C to 30°C is 12 minutes, whereas cup S only took 6 minutes.',
      reasoning: 'showing that Material R is a poorer conductor of heat, slowing down the transfer of heat from the warmer surrounding air to the ice cubes, allowing the ice in cup R to melt more slowly.'
    }
  ];
  
  const sampleBlanks = {
    'sample_answer_1_claim': { 3: true, 5: true },
    'sample_answer_1_evidence': { 5: true, 12: true },
    'sample_answer_1_reasoning': { 3: true, 8: true, 10: true }
  };
  
  questionBank.push({
    id: 'q_sample_1',
    title: 'Question 1',
    category: 'CER (Open Ended)',
    topic: 'Heat',
    blocks: sampleBlocks,
    blanks: sampleBlanks,
    createdAt: new Date().toISOString(),
    createdBy: 'Admin'
  });
  
  saveToStorage();
  updateCounts();
}

// =====================================================================
// INITIALIZATION
// =====================================================================
document.addEventListener('DOMContentLoaded', () => {
  // Auto-login for demo if needed
  renderBlocks();
});

// Close overlays on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closePreview();
    closeConfirm();
  }
});

// Close preview on outside click
document.getElementById('previewOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('previewOverlay')) {
    closePreview();
  }
});

// Load sample data after login
const origLogin = handleLogin;
handleLogin = function() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (USERS[user] && USERS[user].password === pass) {
    currentUser = { username: user, ...USERS[user] };
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appWrapper').style.display = 'flex';
    document.querySelector('.avatar').textContent = currentUser.name[0];
    document.querySelector('.sidebar-footer div div:first-child').textContent = currentUser.name;
    loadFromStorage();
    loadSampleData();
    showToast('Welcome back, ' + currentUser.name + '!', 'success');
  } else {
    document.getElementById('loginError').style.display = 'block';
    setTimeout(() => { document.getElementById('loginError').style.display = 'none'; }, 3000);
  }
};
</script>
</body>
</html>
